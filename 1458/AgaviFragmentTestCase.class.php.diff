# This patch file was generated by NetBeans IDE
# This patch can be applied using context Tools: Apply Diff Patch action on respective folder.
# It uses platform neutral UTF-8 encoding.
# Above lines and this line are ignored by the patching process.
--- 3rdparty\agavi\src\testing\AgaviFragmentTestCase.class.php
+++ src\libs\agavi\testing\AgaviFragmentTestCase.class.php
@@ -201,12 +201,23 @@
 		$context = $this->getContext();
 
 		$ecfi = $context->getFactoryInfo('execution_container');
-		$wrapper_class = $ecfi['class'].'UnitTesting';
 
+		// Work around wonky process isolation by implementing a signalling
+		// interface. The process isolation may in some cases cause repeated
+		// appending of "UnitTesting" to the execution container class name 
+		// until the nesting level becomes too deep
+		$rc = new ReflectionClass($ecfi['class']);
+		
+		if (!$rc->implementsInterface('AgaviIUnitTesting')) {
+			$wrapper_class = $ecfi['class'] . 'UnitTesting';
+		} else {
+			$wrapper_class = $ecfi['class'];
+		}
+
 		//extend the original class to add a setter for the action instance
 		if(!class_exists($wrapper_class)) {
 			$code = sprintf('
-class %1$s extends %2$s
\ No newline at end of file
+class %1$s extends %2$s implements AgaviIUnitTesting
\ No newline at end of file
 {
 
 	public function setActionInstance(AgaviAction $action)
